name: Deploy Nuxt 3 App to DigitalOcean

on:
  push:
    branches:
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: npm install  # or yarn install

    - name: Build
      run: npm run build  # or yarn build

    - name: Deploy to DigitalOcean
      env:
        SSH_PRIVATE_KEY: ${{ secrets.DROPLET_SSH_PRIVATE_KEY }}
        HOST: ${{ secrets.DROPLET_HOST }}
        USERNAME: ${{ secrets.DROPLET_USERNAME }}
      run: |
        # Install SSH Client
        sudo apt-get update
        sudo apt-get install -y openssh-client
        # Ensure .ssh directory exists
        mkdir -p ~/.ssh
        # Start SSH agent
        eval "$(ssh-agent -s)"
        # Add private key to SSH agent
        ssh-add - <<< "${SSH_PRIVATE_KEY}"
        # Disable host key checking (for automation)
        ssh-keyscan -H "$HOST" >> ~/.ssh/known_hosts
        # Sync files to Droplet
        rsync -avz --exclude node_modules . $USERNAME@$HOST:/root/31mp/healthline
        # SSH into Droplet and restart application using PM2
        ssh $USERNAME@$HOST << 'ENDSSH'
        cd /root/31mp/healthline
        pm2 restart TMP-COMPRO
        ENDSSH